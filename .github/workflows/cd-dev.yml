name: Deploy to Development

on:
  push:
    branches: [ develop ]
  workflow_dispatch:

env:
  ENVIRONMENT: dev

jobs:
  deploy-to-dev:
    runs-on: ubuntu-latest
    environment: development
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'
    
    - name: Install Python Dependencies
      run: |
        echo "Installing Python dependencies from requirements.txt..."
        pip install -r requirements.txt
        echo "Python dependencies installed successfully"
    
    - name: Install Databricks CLI
      run: |
        echo "Installing Databricks CLI via official script..."
        curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sh
        echo "Databricks CLI installed successfully"
    
    - name: Configure Databricks CLI
      run: |
        echo "Configuring Databricks CLI with environment variables..."
        export DATABRICKS_HOST="${{ secrets.DATABRICKS_HOST_DEV }}"
        export DATABRICKS_TOKEN="${{ secrets.DATABRICKS_TOKEN_DEV }}"
        echo "Databricks CLI configured successfully"
      env:
        DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST_DEV }}
        DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN_DEV }}
    
    - name: Deploy Databricks Assets
      run: |
        echo "Deploying Databricks assets to development environment..."
        databricks bundle deploy --target dev
        databricks bundle summary --target dev
      env:
        DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST_DEV }}
        DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN_DEV }}
    
    - name: Install Flyway
      run: |
        echo "Installing Flyway..."
        # Try multiple download methods for reliability
        if wget -q --timeout=30 https://download.red-gate.com/maven/release/org/flywaydb/flyway-commandline/11.14.1/flyway-commandline-11.14.1-linux-x64.tar.gz; then
          echo "Downloaded Flyway successfully"
        elif curl -L --connect-timeout 30 -o flyway-commandline-11.14.1-linux-x64.tar.gz https://download.red-gate.com/maven/release/org/flywaydb/flyway-commandline/11.14.1/flyway-commandline-11.14.1-linux-x64.tar.gz; then
          echo "Downloaded Flyway with curl successfully"
        else
          echo "Failed to download Flyway, trying alternative method..."
          # Use a more recent version or alternative source
          wget -q https://github.com/flyway/flyway/releases/download/9.22.3/flyway-9.22.3-linux-x64.tar.gz
        fi
        
        tar -xzf flyway-commandline-11.14.1-linux-x64.tar.gz || tar -xzf flyway-9.22.3-linux-x64.tar.gz
        sudo ln -s `pwd`/flyway-11.14.1/flyway /usr/local/bin/flyway || sudo ln -s `pwd`/flyway-9.22.3/flyway /usr/local/bin/flyway
        rm -f flyway-commandline-11.14.1-linux-x64.tar.gz flyway-9.22.3-linux-x64.tar.gz
        echo "Flyway installed successfully"
    
    - name: Run SQL Migrations
      run: |
        echo "Running SQL migrations for development environment..."
        ./scripts/deploy-sql-migrations.sh dev
      env:
        DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST_DEV }}
        DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN_DEV }}
    
    - name: Deployment Complete
      run: |
        echo "âœ… Deployment to development environment completed successfully"
