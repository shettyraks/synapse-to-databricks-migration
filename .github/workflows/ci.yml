name: Continuous Integration

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: '3.8'

jobs:
  validate-notebooks:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install databricks-cli pytest black flake8 PyYAML
    
    - name: Validate Databricks notebooks
      run: |
        python scripts/validate_notebooks.py
    
    - name: Lint Python code
      run: |
        find . -name "*.py" -not -path "./.git/*" | xargs flake8 --max-line-length=88
        black --check --diff .
    
    - name: Run unit tests
      run: |
        if [ -d "tests" ]; then
          pytest tests/ -v --cov=. --cov-report=xml
        else
          echo "No tests directory found, skipping unit tests"
        fi
    
    - name: Upload coverage reports
      if: success() && exists('coverage.xml')
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml

  validate-sql:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Flyway
      run: |
        wget -q https://download.red-gate.com/maven/release/org/flywaydb/flyway-commandline/11.14.1/flyway-commandline-11.14.1-linux-x64.tar.gz
        tar -xzf flyway-commandline-11.14.1-linux-x64.tar.gz
        sudo ln -s `pwd`/flyway-11.14.1/flyway /usr/local/bin/flyway
        rm flyway-commandline-11.14.1-linux-x64.tar.gz
    
    - name: Validate SQL syntax
      run: |
        echo "Validating SQL files..."
        find . -name "*.sql" -not -path "./.git/*" -not -path "./flyway-*/*" | while read file; do
          echo "Checking $file"
          # Basic SQL syntax check - look for common SQL keywords
          if grep -q "CREATE TABLE\|INSERT INTO\|ALTER TABLE\|DROP TABLE" "$file"; then
            echo "✅ $file contains valid SQL structure"
          else
            echo "⚠️  $file may not contain standard SQL statements"
          fi
        done
        echo "SQL validation completed"

  validate-databricks-config:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Databricks CLI
      run: |
        pip install databricks-cli
    
    - name: Validate databricks.yml
      run: |
        echo "Validating databricks.yml configuration..."
        # Basic YAML syntax check
        python -c "import yaml; yaml.safe_load(open('databricks.yml'))" && echo "✅ databricks.yml has valid YAML syntax"
        # Check for required sections
        if grep -q "bundle:" databricks.yml && grep -q "workspace:" databricks.yml; then
          echo "✅ databricks.yml contains required sections"
        else
          echo "❌ databricks.yml missing required sections"
          exit 1
        fi
        echo "Databricks configuration validation completed"
