name: Continuous Integration

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: '3.8'

jobs:
  validate-notebooks:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install databricks-cli pytest black flake8 nbformat
    
    - name: Validate Databricks notebooks
      run: |
        python scripts/validate_notebooks.py
    
    - name: Lint Python code
      run: |
        find . -name "*.py" -not -path "./.git/*" | xargs flake8 --max-line-length=88
        black --check --diff .
    
    - name: Run unit tests
      run: |
        pytest tests/ -v --cov=. --cov-report=xml
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml

  validate-sql:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Flyway
      run: |
        wget -qO- https://download.red-gate.com/maven/release/org/flywaydb/flyway-commandline/11.14.1/flyway-commandline-11.14.1-linux-x64.tar.gz | tar xvz
        sudo ln -s `pwd`/flyway-11.14.1/flyway /usr/local/bin/flyway
    
    - name: Validate SQL syntax
      run: |
        find . -name "*.sql" -not -path "./.git/*" | while read file; do
          echo "Validating $file"
          flyway validate -sqlFiles="$file" -url="jdbc:h2:mem:test" -user="sa" -password=""
        done

  validate-databricks-config:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Databricks CLI
      run: |
        pip install databricks-cli
    
    - name: Validate databricks.yml
      run: |
        databricks bundle validate
